name: Deploy Database Permissions

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (preview changes only)'
        required: false
        type: boolean
        default: true
      force_update:
        description: 'Force update of system roles'
        required: false
        type: boolean
        default: false

  # Trigger on changes to permissions.yml
  push:
    branches:
      - main
    paths:
      - 'backend/src/config/permissions.yml'

jobs:
  validate-and-deploy:
    name: Validate and Deploy Permissions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Validate permissions.yml
        working-directory: backend
        run: |
          echo "Validating permissions configuration..."
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            const path = require('path');

            try {
              const config = yaml.load(fs.readFileSync('src/config/permissions.yml', 'utf8'));

              if (!config.permissions || !Array.isArray(config.permissions)) {
                throw new Error('Invalid config: missing or invalid permissions array');
              }

              if (!config.roles || !Array.isArray(config.roles)) {
                throw new Error('Invalid config: missing or invalid roles array');
              }

              console.log('âœ“ Configuration is valid');
              console.log(\`  Permissions: \${config.permissions.length}\`);
              console.log(\`  Roles: \${config.roles.length}\`);
            } catch (error) {
              console.error('âœ— Configuration validation failed:', error.message);
              process.exit(1);
            }
          "

      - name: Deploy permissions to server
        if: github.ref == 'refs/heads/main'
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/shiv-agri

            # Source environment variables from .env file
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | xargs)
              echo "âœ“ Environment variables loaded from .env"
            else
              echo "âš  Warning: .env file not found"
            fi

            echo "ðŸ”„ Pulling latest API image..."
            echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
            docker compose -f docker-compose.prod.yml pull api

            echo "ðŸ”„ Restarting API container with new image..."
            docker compose -f docker-compose.prod.yml up -d api

            # Wait for container to be healthy
            echo "â³ Waiting for API container to be ready..."
            sleep 5

            # Determine migration mode
            DRY_RUN="${{ inputs.dry_run }}"
            FORCE_UPDATE="${{ inputs.force_update }}"

            # Default to regular migration when triggered by push
            if [ "${{ github.event_name }}" == "push" ]; then
              DRY_RUN="false"
            fi

            if [ "$DRY_RUN" == "true" ]; then
              echo "ðŸ” Running migration in DRY RUN mode..."
              echo "No changes will be made to the database"
              docker exec shivagri-api npm run migrate:permissions:dry-run
            elif [ "$FORCE_UPDATE" == "true" ]; then
              echo "âš ï¸  Running migration with FORCE UPDATE..."
              echo "System roles will be updated"
              docker exec shivagri-api npm run migrate:permissions:force
            else
              echo "ðŸš€ Running permission migration..."
              docker exec shivagri-api npm run migrate:permissions
            fi

            echo "âœ… Permission migration completed successfully!"

      - name: Create deployment summary
        if: github.ref == 'refs/heads/main'
        run: |
          echo "## Permission Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Server:** ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run || 'false (auto-deploy)' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Update:** ${{ inputs.force_update || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Permission migration completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Permission Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The permission migration failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
