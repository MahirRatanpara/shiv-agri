name: Deploy Database Permissions

on:
  # Called by deploy-api workflow after successful deployment
  workflow_call:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (preview changes only)'
        required: false
        type: boolean
        default: false
      force_update:
        description: 'Force update of system roles'
        required: false
        type: boolean
        default: false
      triggered_by:
        description: 'Workflow that triggered this (for tracking)'
        required: false
        type: string
        default: 'manual'

  # Manual trigger - for standalone permissions updates
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (preview changes only)'
        required: false
        type: boolean
        default: true
      force_update:
        description: 'Force update of system roles'
        required: false
        type: boolean
        default: false

  # Trigger on direct changes to permissions.yml only (not backend/**)
  # When backend/** changes, this runs via deploy-api.yml workflow
  push:
    branches:
      - main
    paths:
      - 'backend/src/config/permissions.yml'

jobs:
  validate-and-deploy:
    name: Validate and Deploy Permissions
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Validate permissions.yml
        working-directory: backend
        run: |
          echo "Validating permissions configuration..."
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            const path = require('path');

            try {
              const config = yaml.load(fs.readFileSync('src/config/permissions.yml', 'utf8'));

              if (!config.permissions || !Array.isArray(config.permissions)) {
                throw new Error('Invalid config: missing or invalid permissions array');
              }

              if (!config.roles || !Array.isArray(config.roles)) {
                throw new Error('Invalid config: missing or invalid roles array');
              }

              console.log('âœ“ Configuration is valid');
              console.log(\`  Permissions: \${config.permissions.length}\`);
              console.log(\`  Roles: \${config.roles.length}\`);
            } catch (error) {
              console.error('âœ— Configuration validation failed:', error.message);
              process.exit(1);
            }
          "

      - name: Copy permissions.yml to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          source: "backend/src/config/permissions.yml"
          target: "/tmp/shiv-agri-permissions/"
          strip_components: 3

      - name: Deploy permissions to server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            cd /var/www/shiv-agri

            # Source environment variables from .env file
            if [ -f .env ]; then
              export $(cat .env | grep -v '^#' | xargs)
              echo "âœ“ Environment variables loaded from .env"
            else
              echo "âš  Warning: .env file not found"
            fi

            # Ensure API container is running
            if ! docker ps | grep -q shivagri-api; then
              echo "âš ï¸  API container is not running. Starting it now..."
              echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u ${{ secrets.DOCKERHUB_USERNAME }} --password-stdin
              docker compose -f docker-compose.prod.yml pull api
              docker compose -f docker-compose.prod.yml up -d api
              sleep 10
            fi

            # Create config directory in Docker if it doesn't exist
            docker exec shivagri-api mkdir -p /app/src/config

            # Copy permissions.yml from /tmp to Docker container
            echo "ðŸ“‹ Copying permissions.yml to Docker container..."
            docker cp /tmp/shiv-agri-permissions/permissions.yml shivagri-api:/app/src/config/permissions.yml

            # Verify the file was copied
            if docker exec shivagri-api test -f /app/src/config/permissions.yml; then
              echo "âœ“ permissions.yml successfully copied to container"
            else
              echo "âœ— Failed to copy permissions.yml to container"
              exit 1
            fi

            # Wait for container to be healthy
            echo "â³ Waiting for API container to be ready..."
            sleep 5

            # Determine migration mode
            DRY_RUN="${{ inputs.dry_run }}"
            FORCE_UPDATE="${{ inputs.force_update }}"

            # Default to regular migration when triggered by push
            if [ "${{ github.event_name }}" == "push" ]; then
              DRY_RUN="false"
            fi

            if [ "$DRY_RUN" == "true" ]; then
              echo "ðŸ” Running migration in DRY RUN mode..."
              echo "No changes will be made to the database"
              docker exec shivagri-api npm run migrate:permissions:dry-run
            elif [ "$FORCE_UPDATE" == "true" ]; then
              echo "âš ï¸  Running migration with FORCE UPDATE..."
              echo "System roles will be updated"
              docker exec shivagri-api npm run migrate:permissions:force
            else
              echo "ðŸš€ Running permission migration..."
              docker exec shivagri-api npm run migrate:permissions
            fi

            # Clean up temp file
            rm -f /tmp/shiv-agri-permissions/permissions.yml
            echo "âœ… Permission migration completed successfully!"

      - name: Create deployment summary
        run: |
          TRIGGER_SOURCE="${{ inputs.triggered_by || github.event_name }}"

          echo "## Permission Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$TRIGGER_SOURCE" == "deploy-api" ]; then
            echo "**Mode:** Automatic (After API deployment)" >> $GITHUB_STEP_SUMMARY
          elif [ "$TRIGGER_SOURCE" == "workflow_dispatch" ]; then
            echo "**Mode:** Manual (Standalone)" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Automatic (permissions.yml changed)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "**Server:** ${{ secrets.SERVER_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Update:** ${{ inputs.force_update || 'false' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Permission migration completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Permission Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The permission migration failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Event:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
