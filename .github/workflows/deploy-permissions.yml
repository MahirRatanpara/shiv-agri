name: Deploy Database Permissions

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - production
          - staging
        default: 'staging'
      dry_run:
        description: 'Run in dry-run mode (preview changes only)'
        required: false
        type: boolean
        default: true
      force_update:
        description: 'Force update of system roles'
        required: false
        type: boolean
        default: false

  # Trigger on changes to permissions.yml
  push:
    branches:
      - main
    paths:
      - 'backend/src/config/permissions.yml'

jobs:
  deploy-permissions:
    name: Deploy Permissions to Database
    runs-on: ubuntu-latest

    environment:
      name: ${{ inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        working-directory: backend
        run: npm ci

      - name: Validate permissions.yml
        working-directory: backend
        run: |
          echo "Validating permissions configuration..."
          node -e "
            const fs = require('fs');
            const yaml = require('js-yaml');
            const path = require('path');

            try {
              const config = yaml.load(fs.readFileSync('src/config/permissions.yml', 'utf8'));

              if (!config.permissions || !Array.isArray(config.permissions)) {
                throw new Error('Invalid config: missing or invalid permissions array');
              }

              if (!config.roles || !Array.isArray(config.roles)) {
                throw new Error('Invalid config: missing or invalid roles array');
              }

              console.log('âœ“ Configuration is valid');
              console.log(\`  Permissions: \${config.permissions.length}\`);
              console.log(\`  Roles: \${config.roles.length}\`);
            } catch (error) {
              console.error('âœ— Configuration validation failed:', error.message);
              process.exit(1);
            }
          "

      - name: Setup SSH for production
        if: ${{ inputs.environment == 'production' || github.ref == 'refs/heads/main' }}
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.PRODUCTION_SSH_KEY }}

      - name: Run migration (Dry Run)
        if: ${{ inputs.dry_run == true }}
        working-directory: backend
        run: |
          echo "ðŸ” Running migration in DRY RUN mode..."
          echo "No changes will be made to the database"
          echo ""
          npm run migrate:permissions:dry-run

      - name: Run migration (Production)
        if: ${{ inputs.dry_run == false || github.ref == 'refs/heads/main' }}
        working-directory: backend
        run: |
          echo "ðŸš€ Running permission migration..."

          if [ "${{ inputs.force_update }}" == "true" ]; then
            echo "âš ï¸  Force update enabled - system roles will be updated"
            npm run migrate:permissions:force
          else
            npm run migrate:permissions
          fi

      - name: Verify migration
        if: ${{ inputs.dry_run == false || github.ref == 'refs/heads/main' }}
        working-directory: backend
        run: |
          echo "Verifying migration results..."
          node -e "
            const mongoose = require('mongoose');
            require('dotenv').config({ path: './src/.env' });

            async function verify() {
              try {
                await mongoose.connect(process.env.MONGODB_URI);

                const Permission = require('./src/models/Permission');
                const Role = require('./src/models/Role');

                const permissionCount = await Permission.countDocuments({ isActive: true });
                const roleCount = await Role.countDocuments({ isActive: true });

                console.log('âœ“ Migration verified');
                console.log(\`  Active Permissions: \${permissionCount}\`);
                console.log(\`  Active Roles: \${roleCount}\`);

                await mongoose.disconnect();
              } catch (error) {
                console.error('âœ— Verification failed:', error.message);
                process.exit(1);
              }
            }

            verify();
          "

      - name: Create deployment summary
        if: ${{ inputs.dry_run == false || github.ref == 'refs/heads/main' }}
        run: |
          echo "## Permission Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "**Force Update:** ${{ inputs.force_update }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Permission migration completed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Notify on failure
        if: failure()
        run: |
          echo "## âŒ Permission Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The permission migration failed. Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment || 'staging' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        working-directory: backend/src
        run: rm -f .env
