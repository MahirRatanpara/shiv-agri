<div class="role-management-container" *hasPermission="'roles.view'">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>Role Management</h1>
      <p class="subtitle">Manage roles and permissions for your team</p>
    </div>
    <button
      *hasPermission="'roles.create'"
      class="btn btn-primary"
      (click)="openCreateModal()"
    >
      <span class="icon">+</span> Create Role
    </button>
  </div>

  <!-- Filters -->
  <div class="filters">
    <div class="search-box">
      <input
        type="text"
        [(ngModel)]="searchTerm"
        placeholder="Search roles..."
        class="search-input"
      />
    </div>
    <label class="checkbox-label">
      <input
        type="checkbox"
        [(ngModel)]="filterByActive"
        (change)="loadRoles()"
      />
      <span>Active only</span>
    </label>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Loading roles...</p>
  </div>

  <!-- Roles Grid -->
  <div *ngIf="!loading" class="roles-grid">
    <div *ngFor="let role of filteredRoles" class="role-card">
      <div class="role-header">
        <div class="role-info">
          <div class="role-icon" [style.background-color]="role.color">
            {{ role.icon || 'üë§' }}
          </div>
          <div>
            <h3>{{ role.displayName }}</h3>
            <span class="role-name">{{ role.name }}</span>
            <span *ngIf="role.isSystem" class="badge badge-system">System</span>
          </div>
        </div>
        <div class="role-actions">
          <button
            class="btn-icon"
            (click)="openPermissionsModal(role)"
            title="View Permissions"
          >
            üîí
          </button>
          <button
            *hasPermission="'roles.update'"
            class="btn-icon"
            (click)="openEditModal(role)"
            title="Edit Role"
          >
            ‚úèÔ∏è
          </button>
          <button
            *ngIf="!role.isSystem"
            class="btn-icon btn-danger"
            (click)="openDeleteModal(role)"
            title="Delete Role"
          >
            üóëÔ∏è
          </button>
        </div>
      </div>

      <p class="role-description">{{ role.description }}</p>

      <div class="role-stats">
        <div class="stat">
          <span class="stat-value">{{ role.permissions.length || 0 }}</span>
          <span class="stat-label">Permissions</span>
        </div>
        <div class="stat">
          <span class="stat-value">{{ role.userCount || 0 }}</span>
          <span class="stat-label">Users</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="!loading && filteredRoles.length === 0" class="empty-state">
    <p>No roles found</p>
  </div>
</div>

<!-- Create/Edit Modal -->
<div *ngIf="showCreateModal || showEditModal" class="modal-overlay" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ showCreateModal ? 'Create New Role' : 'Edit Role' }}</h2>
      <button class="btn-close" (click)="closeModal()">√ó</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="roleName">Role Name *</label>
        <input
          id="roleName"
          type="text"
          [(ngModel)]="roleForm.name"
          [disabled]="showEditModal"
          placeholder="e.g., lab_technician"
          class="form-input"
        />
        <small>Lowercase, underscores allowed</small>
      </div>

      <div class="form-group">
        <label for="displayName">Display Name *</label>
        <input
          id="displayName"
          type="text"
          [(ngModel)]="roleForm.displayName"
          placeholder="e.g., Lab Technician"
          class="form-input"
        />
      </div>

      <div class="form-group">
        <label for="description">Description *</label>
        <textarea
          id="description"
          [(ngModel)]="roleForm.description"
          placeholder="Brief description of this role"
          class="form-textarea"
          rows="3"
        ></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="color">Color</label>
          <input
            id="color"
            type="color"
            [(ngModel)]="roleForm.color"
            class="form-input-color"
          />
        </div>

        <div class="form-group">
          <label for="priority">Priority</label>
          <input
            id="priority"
            type="number"
            [(ngModel)]="roleForm.priority"
            min="0"
            class="form-input"
          />
          <small>Lower = Higher priority</small>
        </div>
      </div>

      <div class="form-group">
        <label>Permissions *</label>
        <div class="permissions-section">
          <div *ngFor="let resource of objectKeys(groupedPermissions)" class="permission-group">
            <div class="permission-group-header">
              <label class="checkbox-label">
                <input
                  type="checkbox"
                  [checked]="isResourceGroupSelected(resource)"
                  (change)="toggleResourceGroup(resource)"
                />
                <strong>{{ resource }}</strong>
              </label>
            </div>
            <div class="permission-list">
              <label
                *ngFor="let permission of groupedPermissions[resource]"
                class="checkbox-label permission-item"
              >
                <input
                  type="checkbox"
                  [checked]="isPermissionSelected(permission.id)"
                  (change)="togglePermission(permission.id)"
                />
                <span>
                  <strong>{{ permission.action }}</strong>
                  <small>{{ permission.description }}</small>
                </span>
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      <button
        class="btn btn-primary"
        (click)="showCreateModal ? createRole() : updateRole()"
        [disabled]="loading"
      >
        {{ loading ? 'Saving...' : (showCreateModal ? 'Create Role' : 'Update Role') }}
      </button>
    </div>
  </div>
</div>

<!-- Permissions View Modal -->
<div *ngIf="showPermissionsModal && selectedRole" class="modal-overlay" (click)="closeModal()">
  <div class="modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>{{ selectedRole.displayName }} - Permissions</h2>
      <button class="btn-close" (click)="closeModal()">√ó</button>
    </div>

    <div class="modal-body">
      <p class="modal-description">{{ selectedRole.description }}</p>

      <div class="permissions-list">
        <div *ngFor="let permission of selectedRole.permissions" class="permission-badge">
          <span class="permission-resource">{{ permission.resource }}</span>
          <span class="permission-action">{{ permission.action }}</span>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Close</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div *ngIf="showDeleteModal && roleToDelete" class="modal-overlay" (click)="closeModal()">
  <div class="modal modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>Delete Role</h2>
      <button class="btn-close" (click)="closeModal()">√ó</button>
    </div>

    <div class="modal-body">
      <p>
        Are you sure you want to delete the role
        <strong>{{ roleToDelete.displayName }}</strong>?
      </p>
      <p class="warning-text">
        This action cannot be undone. Make sure no users have this role before deleting.
      </p>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closeModal()">Cancel</button>
      <button
        class="btn btn-danger"
        (click)="deleteRole()"
        [disabled]="loading"
      >
        {{ loading ? 'Deleting...' : 'Delete Role' }}
      </button>
    </div>
  </div>
</div>

<!-- Access Denied -->
<div *hasPermission="'roles.view'; else: noAccess"></div>
<ng-template #noAccess>
  <div class="access-denied">
    <h2>Access Denied</h2>
    <p>You don't have permission to view role management.</p>
  </div>
</ng-template>
